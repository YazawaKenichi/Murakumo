回路設計時のノート

いろいろ悩みそうなところだけど、どこから悩めばいいのかもわからなかったので、まずはモータドライバ回路から設計しようと思う。

モータドライバ設計の前に、H ブリッジを駆動するためのゲートドライバ選びについて記述する。
##### ゲートドライバ
まず、ゲートドライバに必要な要素は以下の通り。
- Nch フルブリッジ回路を組むことができるか？
- 100% duty で出力できるか？
ということらしい。

###### Nch フルブリッジ回路
Nch フルブリッジ回路を組むことの利点は以下。
- Pch は Nch に比べて性能が低い。
- Pch は品種があまりない。
- パワー素子は一種類のみで済ませて手間を省きたい。（Pch か Nch にそろえて同じ素子を使って製作できるようにしたい。）
- Pch は値段が高い。
上記理由を先輩に教えていただいたが、教えていただいた後にネットを探したところ、同様の記述を発見した。[参考](http://blog.livedoor.jp/wata_net/archives/2147292.html)。
[こっちのサイト](https://qiita.com/panzakii/items/97eca16954d34ecf0c8b)には「なぜフルNchにこだわるかというと、単純にその方が流せる電流が大きくなるからです。実はPchFETはNchFETに比べ流せる電流が少ないのです。原理について説明しだすと本当にキリがないので説明しません。興味のある人はググってください。」などと記述されているが、ググってもそんな記述は一切出てこない。なんなんだ。

「品種が多いから Pch よりも大電流の流せる Nch MOSFET」ならわかるが、「原理」とか「説明しだすとキリがない」とか記述されているのは本当に意味が分からない。

###### 100% duty で出力
- 最大出力で出せたほうが良いにきまっとるやろ！

二つのメリットをカバーできて、より入手しやすい IC が A3921 だそうで、それが理由でよく利用される。
A3921 の仕様
ゲート電圧は基準電位から +15V 以内の範囲が出力される様子。具体的には、ハイサイド出力が SA の電位よりも 0 ~ 15V 高くなり、ローサイド出力が GND 電位よりも -5 ~ 16V 高くなるように出力される。

A3921 のデータシートを読んで得た情報
- GHA and GHB Pins
- ゲート抵抗はできるだけ FET に近いところに置く必要がある。（なんでや）
- ＞ そもそもゲート抵抗をつける理由として
- ＞＞ FET 内部のコンデンサ成分と、導線自体によるインダクタンス成分が共振し、それに影響して FET やマイコンが破損する恐れがある。
- ＞＞ ドレイン電圧の立ち上がりと立下りが早すぎてノイズへの影響が大きくなる。
- ＞＞ ゲート電流が大きすぎて FET 前段の制御回路が破損する。
- ＞ この中で FET と抵抗の距離と関係がありそうな理由としては「導線自体のインダクタンス」だろう。抵抗からFETまでの導線の長さを小さくする、すなわちインダクタンスを小さくすることでノイズを軽減するといったところか。
- いまいちよくわからないところが、「GHx going low turns on the lower half of the drive, sinking current from the external FET gate circuit to the corresponding Sx pin, turning off the FET.」の一文で、GHx を Low にしたらドライブの下半分が ON になる？ってどういうことだ？
- Bootstrap Capacitor Selection
- ブートストラップコンデンサ CBOOTx は、正しく選択する必要がある。
- コンデンサの静電容量が大きいと、コンデンサの充電に時間が浪費され、結果として最大デューティーサイクルと PWM 周波数の制限が小さくなってしまう。
- 逆に小さいと、Charge Sharing によって、電荷が CBOOTx から FET ゲートに転送されるときに大きな電圧降下が発生する可能性があるらしい。
- ＞ Charge Sharing ってなんだ？
- ＞＞ 英語版 Wiki によると、Charge Sharing は、ある電子ドメインからほかの電子ドメインへの電荷の移動による信号劣化の影響。らしい。は？
- ＞ よくわからないけど、とにかく電荷を共有して、出力電圧レベルが退化したり、誤った出力値が発生したりする可能性があるっぽい。
- この電圧降下を小さくするために、CBOOTx の電荷 QBOOT は、FET のゲート QGATE に必要な電荷よりもはるかに大きくする必要がある。その"はるかに大きい"というのは、20 倍だそうだ。
- QBOOT というのは、CBOOTx に蓄えられる電気量なので、CBOOT * VBOOT で求めることができる。そして上記より、これは QGATE の 20 である必要があるので、ブートストラップに接続するコンデンサの、適切な電気容量 CBOOT を求める式は、以下のようになる。
- CBOOT = QGATE * 20 / VBOOT
- 係数 20 を選択した場合、FET が ON の時の VBOOT と OFF の時の VBOOT の差は約 5% だそう。通常動作条件下での VBOOT の最大電圧は VREG らしい。
- ＞ VREG の値について。。。疑問がある。
- ＞＞ Terminal List には Regulated 13V と説明があるのに、
- VBB 電源が 16V より大きいとき、レギュレータは単純なリニアレギュレータとなる。16V 未満では、安定したレギュレートをするために、ポンプコンデンサ CP が必要。
- このコンデンサ CP の最小値は 220nF である必要があり、通常は 470nF を接続する。
- 安定してレギュレートされた 13V は VREG 端子で使用できる。ローサイドドライブとブートストラップコンデンサに過渡充電電流を供給するために十分大きなストレージコンデンサを接続する必要がある。
参考になったサイト
- ハイサイド Nch MOSFET の話やブートストラップ回りについては[このサイト](https://techweb.rohm.co.jp/knowledge/dcdc/dcdc_sr/dcdc_sr01/829)が参考になった。

[このサイト](https://detail-infomation.com/gate-driver-type/)によると、ターンオンを速くする回路よりもターンオフを速くする回路の方が頻繁に用いられるらしい。たしかに、4月に制作したミニトレーサ回路も、ターンオフが速くなる方向にダイオードが設けられていた。ターンオフ抵抗が小さいので、MOSFET のミラー容量を介して誤ターンオンを防ぐ。

##### モータドライバ
ゲートドライバが決まったところで、次に使用する FET とそれにつながる制限抵抗やコンデンサの値を決める必要がある。
特にこの抵抗とコンデンサは真剣に決めないとショートしてリポが死ぬ。マジで。

###### Power MOSFET
FET の耐圧（D-S 間電圧）と流したいドレイン電流（ID 電流）で大体の規格が絞れる。
そこから、[ON 抵抗](https://www.rohm.co.jp/electronics-basics/transistors/tr_what9)と[スイッチング速度]()から、損失の大きさを計算してそれに耐えるものを選ぶ。
DCX 10L 公称 4.5V の起動電流 1.55A で、これに 12V をかける。その時の電流値を考えて使う必要がある。
- 別ディレクトリの Excel データによると ID = 3.06A (2S (8.9V)), 4.34A (3S (12.6V)) であることが算出された。3S 使うことも考えて、4.34A に耐えるものを選ぶようにすればよさそう。
ついでに、配線幅については、右モータと左モータでひとつづつ使うことも考慮して設計する必要がある。よって上記条件によって 4.34mm 以上の配線幅となっていればよいことになる。
- ON 抵抗については、パッケージが小さい方が ON 抵抗が大きく、パッケージが小さいと ON 抵抗が大きくなる。
- 今回作る基板はサイズが比較的大きく、パッケージの違いによる大きさの違いは考慮しなくて良いと思う。よって ON 抵抗のより小さいものを選んでおけば良い。
- [スイッチング速度についてはこのサイトが強そう](https://xtech.nikkei.com/atcl/learning/lecture/19/00080/00002/)
-

***書き途中***

##### ラインセンサ
- 野村先輩によると、アナログ値を返すセンサと、ディジタル値を返すセンサの二種類がある。
- 試しに digikey で調べてみようとしたところ、『光センサ - フォトインタラプタ - スロットタイプ - トランジスタ出力』『光センサ - フォトインタラプタ - スロットタイプ - ロジック出力』という分類があり、トランジスタ出力が一般的なアナログ値を返すフォトインタラプタで、ロジック出力が野村先輩が言っていたディジタル値を返すセンサなのだろう。
- 接続する抵抗によって閾値を変更する。
- [なんかいい感じのサイト見つけた](https://components.omron.com/jp-ja/products/basic-knowledge/sensors/photomicro-sensors/technology)
- [こっちはフォトセンサの設計についてのサイト](https://toshiba-semicon-storage.com/content/dam/toshiba-ss/jp/docs/design-support/elearning/elearning_discrete05_r51.pdf)

##### CPU
先輩が STM32F405RGT6 を束買いしているので、とりあえずこれにするのはアリ。
クロック数とメモリと機能的に、ロボトレにいい塩梅で使えそうなのがこの CPU らしい。

***書き途中***

##### 電源回路
この電源回路を決めるのにレギュレータを選ぶ必要があるのだが、レギュレータの出力が決まらない以上は手の付けようがない。だからさっさとほかの回路作れ。電源選びは最後だ。
